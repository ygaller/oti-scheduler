# CI/CD Pipeline for OTI Scheduler

This document explains the continuous integration and delivery setup for the OTI Scheduler Electron desktop application.

## üèó Architecture Overview

```
Developer ‚Üí Git Push ‚Üí GitHub Actions ‚Üí Automated Build ‚Üí Release ‚Üí Auto-Updater
```

## üîÑ Workflows

### 1. Test Pipeline (`.github/workflows/test.yml`)
**Triggers:** Push to main/master/develop, Pull Requests  
**Purpose:** Quality assurance

- ‚úÖ Run API tests with PostgreSQL
- ‚úÖ TypeScript compilation check
- ‚úÖ Code coverage reporting
- ‚úÖ Lint client and server code

### 2. Electron Build Pipeline (`.github/workflows/build-electron.yml`)
**Triggers:** Version tags (`v*.*.*`)  
**Purpose:** Automated desktop app builds

**Build Matrix:**
- **macOS**: Universal builds (Intel x64 + Apple Silicon ARM64)
- **Windows**: x64 builds with NSIS installer

**Artifacts Generated:**
- `oti-scheduler-1.0.0.dmg` (macOS Universal)
- `oti-scheduler-1.0.0-arm64.dmg` (macOS Apple Silicon)
- `oti-scheduler Setup 1.0.0.exe` (Windows x64)

### 3. Signed Release Pipeline (`.github/workflows/release-signed.yml`)
**Triggers:** Tags with `-release` suffix (`v*.*.*-release`)  
**Purpose:** Production-ready signed builds

**Features:**
- üîí Code signing for both platforms
- üçé macOS notarization
- üîê Windows Extended Validation signing
- üì¶ Production-ready installers

## üöÄ Release Process

### Automated Release
```bash
# Patch release (1.0.0 ‚Üí 1.0.1)
npm run release:patch -- --version 1.0.1

# Minor release (1.0.0 ‚Üí 1.1.0)
npm run release:minor -- --version 1.1.0

# Major release (1.0.0 ‚Üí 2.0.0)
npm run release:major -- --version 2.0.0

# Preview what would happen
npm run release -- --version 1.0.1 --dry-run
```

### Manual Release
```bash
# 1. Update versions
npm version 1.0.1

# 2. Build and test
npm run prepare:electron

# 3. Create and push tag
git tag -a v1.0.1 -m "Release 1.0.1"
git push origin v1.0.1

# 4. GitHub Actions will handle the rest
```

## üîß Environment Setup

### GitHub Secrets (Required for Signed Builds)

#### macOS Code Signing
```
APPLE_CERT_DATA          # Base64 encoded Developer ID certificate (.p12)
APPLE_CERT_PASSWORD      # Certificate password
APPLE_ID                 # Apple ID for notarization
APPLE_ID_PASSWORD        # App-specific password
APPLE_TEAM_ID           # Developer Team ID
```

#### Windows Code Signing
```
WINDOWS_CERT_DATA        # Base64 encoded code signing certificate (.p12)
WINDOWS_CERT_PASSWORD    # Certificate password
```

#### Auto-Updater
```
GITHUB_TOKEN            # Automatically provided by GitHub
```

### Setting up Code Signing

#### macOS (Developer ID Certificate)
1. **Obtain Certificate:**
   - Enroll in Apple Developer Program
   - Create Developer ID Application certificate
   - Download as .p12 file

2. **Configure Secrets:**
   ```bash
   # Convert certificate to base64
   base64 -i certificate.p12 | pbcopy
   # Paste result into APPLE_CERT_DATA secret
   ```

#### Windows (Code Signing Certificate)
1. **Obtain Certificate:**
   - Purchase from CA (DigiCert, Sectigo, etc.)
   - Get Extended Validation (EV) certificate for best trust

2. **Configure Secrets:**
   ```bash
   # Convert certificate to base64
   base64 -i certificate.p12 | pbcopy
   # Paste result into WINDOWS_CERT_DATA secret
   ```

## üì¶ Distribution

### Release Types

#### Development Builds
- **Trigger:** Any `v*.*.*` tag
- **Features:** Basic functionality testing
- **Signing:** Disabled (faster builds)
- **Use:** Internal testing, development

#### Production Builds
- **Trigger:** `v*.*.*-release` tags
- **Features:** Full code signing and notarization
- **Signing:** Enabled (slower but secure)
- **Use:** End-user distribution

### Download Links
After release, users can download from:
- **GitHub Releases:** `https://github.com/ygaller/oti-scheduler/releases`
- **Direct URLs:** Auto-generated by GitHub

## üîÑ Auto-Updater

### How It Works
1. **Check for Updates:** App checks GitHub releases on startup
2. **Download:** If available, downloads update in background
3. **Install:** User prompted to restart and install
4. **Verification:** Only signed updates are accepted

### Update Channels
- **Stable:** Production releases (`v1.0.0`)
- **Beta:** Prerelease versions (`v1.0.0-beta.1`)

### User Experience
```
App Startup ‚Üí Check Updates ‚Üí Download (Background) ‚Üí Prompt User ‚Üí Install ‚Üí Restart
```

## üõ† Development Workflow

### Feature Development
```bash
# 1. Create feature branch
git checkout -b feature/new-scheduling-algorithm

# 2. Develop and test
npm run dev
npm run electron:dev

# 3. Run tests
npm test

# 4. Create PR
git push origin feature/new-scheduling-algorithm
```

### Release Process
```bash
# 1. Merge to master
git checkout master
git merge feature/new-scheduling-algorithm

# 2. Run release script
npm run release:patch -- --version 1.0.1

# 3. CI/CD handles build and distribution automatically
```

### Hotfix Process
```bash
# 1. Create hotfix branch from master
git checkout -b hotfix/critical-bug-fix

# 2. Fix and test
npm run prepare:electron

# 3. Fast-track release
npm run release:patch -- --version 1.0.2

# 4. Merge back to develop
git checkout develop
git merge hotfix/critical-bug-fix
```

## üìä Monitoring

### Build Status
- **GitHub Actions:** Monitor workflow runs
- **Status Badges:** README shows current build status
- **Notifications:** GitHub notifications for failed builds

### Release Analytics
- **Download Counts:** GitHub provides download statistics
- **User Feedback:** GitHub Issues for bug reports
- **Update Success:** Auto-updater logs (when implemented)

## üîç Debugging Builds

### Local Build Testing
```bash
# Test build process locally
npm run prepare:electron
npm run dist:mac        # or dist:win

# Check build artifacts
ls -la dist-electron/
```

### CI/CD Debugging
1. **Check Logs:** GitHub Actions provides detailed logs
2. **Artifacts:** Download build artifacts for inspection
3. **Matrix Builds:** Each OS builds independently
4. **Secrets:** Verify all required secrets are set

### Common Issues

#### Build Failures
- **Missing Dependencies:** Check `npm run setup`
- **Node Version:** Ensure Node.js 18+ is used
- **Platform Issues:** Some packages need platform-specific builds

#### Code Signing Issues
- **Certificate Expired:** Renew certificates annually
- **Wrong Certificate Type:** Use Developer ID (not Mac App Store)
- **Notarization Fails:** Check Apple ID credentials

#### Auto-Updater Issues
- **GitHub Token:** Verify token has repository access
- **Release Format:** Ensure proper semantic versioning
- **Update Channel:** Check if app is looking at correct releases

## üìã Maintenance

### Regular Tasks

#### Monthly
- [ ] Update dependencies (`npm audit fix`)
- [ ] Test build process on both platforms
- [ ] Verify code signing certificates validity
- [ ] Review GitHub Actions usage/limits

#### Quarterly
- [ ] Update Electron version
- [ ] Security audit (`npm audit`)
- [ ] Performance benchmarking
- [ ] User feedback review

#### Annually
- [ ] Renew code signing certificates
- [ ] Review and update CI/CD workflows
- [ ] Archive old releases
- [ ] Update documentation

## üÜò Support

### Resources
- **GitHub Actions Docs:** https://docs.github.com/en/actions
- **Electron Builder Docs:** https://www.electron.build/
- **Code Signing Guide:** See platform-specific documentation

### Getting Help
- **GitHub Issues:** Report CI/CD problems
- **GitHub Discussions:** Community support
- **Internal Documentation:** This file and ELECTRON.md

---

## Quick Reference

### Essential Commands
```bash
npm run release:patch -- --version 1.0.1   # Create patch release
npm run prepare:electron                    # Build for testing
npm run electron:dev                        # Development mode
npm run dist:mac                           # Build macOS version
npm run dist:win                           # Build Windows version
```

### Key Files
- `.github/workflows/test.yml` - Test pipeline
- `.github/workflows/build-electron.yml` - Basic builds
- `.github/workflows/release-signed.yml` - Production builds
- `scripts/release.js` - Release automation
- `electron/updater.js` - Auto-updater implementation

### Status Monitoring
- **Builds:** https://github.com/ygaller/oti-scheduler/actions
- **Releases:** https://github.com/ygaller/oti-scheduler/releases
- **Issues:** https://github.com/ygaller/oti-scheduler/issues
